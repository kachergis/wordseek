<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Word-seek v1</title>
        <script src="js/jspsych.js"></script>
        <script src="js/jspsych-html-button-response.js"></script>
        <script src="js/jspsych-audio-button-response.js"></script>
        <script src="js/jspsych-instructions.js"></script>
        <!-- complex-animation embeds an animated sequence of images in a scene and plays audio -->
        <script src="js/jspsych-complex-animation.js"></script>
        <script src="js/mmturkey-0.6.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
        <link href="css/jspsych.css" rel="stylesheet" type="text/css"></link>
        <link href="css/style.css" rel="stylesheet" type="text/css"></link>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    </head>
    <body></body>
    <script>

     var myTimeline = [];

     // images to preload
     var images = ['images/bag3.jpg', 'images/table.png', 'images/Bear_straight.png', "images/Bear_point_l.png", "images/Bear_point_r.png", 'images/Bear_disappear.png'];

     var instructions = {
        type: 'instructions',
        pages: ["<div style='width: 500px; margin: 0 auto; text-align: center; background-color: #8C1516; padding: 20px 15px 10px 10px'>"+
                "<img src='images/stanford.png' height='46' width='360' alt='Stanford University'></div>"+
                "<center><p><strong>Stanford Language and Cognition Lab</strong></p></center>"+
                "<p>In this experiment, you will learn words for new toys. Your task is to "+
                "figure out which word goes with which toy. The materials were "+
                "designed for children. Even if they seem strange at times, we ask you "+
                "to try to be as accurate as possible. You will hear sound, so please "+
                "make sure your volume is turned on. The experiment takes about 7-9 minutes."+
                "<p class='block-text' id='legal'>Legal information: By answering the following questions, you are participating in a study being performed by cognitive scientists in the Stanford Department of Psychology. If you have questions about this research, please contact George Kachergis at <a href='mailto://gkacherg@stanford.edu'>gkacherg@stanford.edu</a>. You must be at least 18 years old to participate. Your participation in this research is voluntary. You may decline to answer any or all of the following questions. You may decline further participation, at any time, without adverse consequences. Your anonymity is assured; the researchers who have requested your participation will not receive any personal information about you.</p>",
        "<div class='w3-container' id='stage'><p><strong>Instructions</strong></p>" +
        "<p>These animals have some strange objects in bags. They will give you some information, and then you can choose which bag open up.</p>" +
        "<img src='images/bag3.jpg' class='bag' id='bag_l'> <img src='images/table.png' class='table' id='table_l'> " +
        "<img src='images/Bear_straight.png' class='agent'> " +
        //"<img src='images/hill.png' class='hill'></div>" +
        " <img src='images/bag3.jpg' class='bag' id='bag_r'> <img src='images/table.png' class='table' id='table_r'> </div>"],
        show_clickable_nav: true,
        show_page_number: true,
        post_trial_gap: 2000
    }

    // myTimeline.push(consent);
    myTimeline.push(instructions);

    // generate subject ID and add to each trial
    var subject_id = jsPsych.randomization.randomID(15);
    jsPsych.data.addProperties({ subject: subject_id });

    function shuffle(a) {
        var j, x, i;
        for (i = a.length - 1; i > 0; i--) {
            j = Math.floor(Math.random() * (i + 1));
            x = a[i];
            a[i] = a[j];
            a[j] = x;
        }
        return a;
    }

    function saveData(name, data){
        var xhr = new XMLHttpRequest();
        xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify({filename: name, filedata: data}));
    }

    var labels = ["bosa", "manu", "stigson"];

    var conditions = ['unknown', 'unlabeled', 'interrupted'];
    var condition_prompts = {
        "unknown": "I donâ€™t know what this one is called.", 
        "unlabeled": "Huh.", 
        "interrupted": "This one is a..."
    };

    labels = shuffle(labels);
    conditions = shuffle(conditions);

    // ToDo: build trial for each label in a for loop
    for (var i = 0; i < conditions.length; i++) {
        
        // randomize pointing left or right first
        if(Math.random()<.5) {
            var animation_sequence = ["images/Bear_straight.png", "images/Bear_point_l.png", "images/Bear_point_r.png", "images/Bear_straight.png"]; // after they click: "images/Bear_disappear.png"
            var point_left_first = true;
        } else {
            var animation_sequence = ["images/Bear_straight.png", "images/Bear_point_r.png", "images/Bear_point_l.png", "images/Bear_straight.png"];
            var point_left_first = false;
        }

        var get_label_prompt = function(label) {
            return("Oh, there's a " + label + " in here!");
        }

        // randomize order of prompt sequence, and track labeled first / second
        if(Math.random()<.5) {
            var prompt_sequence = ["Hi! I'm looking at some new toys.", get_label_prompt(labels[i]), condition_prompts[conditions[i]], "Which bag do you want to look in?"];
            var label_first = true;
        } else {
            var prompt_sequence = ["Hi! I'm looking at some new toys.", condition_prompts[conditions[i]], get_label_prompt(labels[i]), "Which bag do you want to look in?"];
            var label_first = false; 
        }

        var trial = {
            type: 'complex-animation',
            stimuli: animation_sequence,
            scene_html: "<div class='w3-container' id='stage'> <img src='images/bag3.jpg' class='bag' id='bag_l'> <img src='images/table.png' class='table' id='table_l'> " +
            "<img src='images/Bear_straight.png' class='agent'> " + // <img src='images/hill.png' class='hill'>
            "<img src='images/bag3.jpg' class='bag' id='bag_r'> <img src='images/table.png' class='table' id='table_r'> </div> ",
            sequence_reps: 1,
            frame_time: 2000, 
            choices: ['bag_l','bag_r'],
            prompt: prompt_sequence, // should switch to audio
            data: { 
                point_left_first: point_left_first, 
                condition: condition_prompts[conditions[i]],
                label_first: label_first
            }
        };

        myTimeline.push(trial); // test_trial
    }

    var finish_slide = {
       type: 'html-button-response',
       stimulus: "<div class='slide' id='finished'>" +
               "<p>You're finished - thank you for participating</p>" +
              "<p>In this experiment we wanted to find out what cues " +
              "inspire people's curiosity about novel objects.</p>" +
              "<p>Submitting to Mechanical Turk...</p>  </div>",
       choices : ["OK"]
    }

    myTimeline.push(finish_slide);

    jsPsych.init({
        timeline: myTimeline,
        preload_images: images, // preload_audio: audio,
        on_finish: function(){
        saveData("wordseek-data-" + subject_id, jsPsych.data.get().csv());
        jsPsych.data.displayData();
      }
    })

    </script>
</html>
